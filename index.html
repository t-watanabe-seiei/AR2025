<!-- ãƒãƒ¼ã‚«ãƒ¼ã‚’èª­ã¿è¾¼ã‚“ã§ï¼“ï¼¤ãƒ¢ãƒ‡ãƒ«ã‚’è¡¨ç¤º + ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å†ç”Ÿ(anime01 â†’ anime02 â†’ anime03 â†’ anime04)  -->

<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- A-Frame ã‚’èª­ã¿è¾¼ã‚€ -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <!-- AR.js ã‚’èª­ã¿è¾¼ã‚€ -->
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>
    <!-- Gesture Handler ã‚’èª­ã¿è¾¼ã‚€ -->
    <script src="https://raw.githack.com/AR-js-org/studio-backend/master/src/modules/marker/tools/gesture-handler.js"></script>
    <!-- Animation Mixer ã‚’èª­ã¿è¾¼ã‚€ -->
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.min.js"></script>
    <script>
      // ãƒ¢ãƒ‡ãƒ«ã®çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
      AFRAME.registerComponent('model-controller', {
        schema: {
          // åˆæœŸä½ç½®
          initialPosition: { type: 'vec3', default: { x: 0, y: 0, z: 0 } },
          // ç§»å‹•å¾Œã®ä½ç½®
          moveToPosition: { type: 'vec3', default: { x: 5, y: 0, z: 0 } }
        },

        init: function () {
          // ãƒ¢ãƒ‡ãƒ«ã®åˆæœŸçŠ¶æ…‹ã‚’è¨­å®š
          this.el.setAttribute('position', this.data.initialPosition);
          
          // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹ã‚’åˆæœŸåŒ–
          this.isAnimating = false;
          this.currentState = 'initial'; // 'initial' or 'moved'

          // ãƒ¢ãƒ‡ãƒ«ãŒèª­ã¿è¾¼ã¾ã‚ŒãŸæ™‚ã®å‡¦ç†
          this.el.addEventListener('model-loaded', () => {
            // åˆæœŸã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆanime01ã®ãƒ«ãƒ¼ãƒ—ï¼‰ã‚’é–‹å§‹
            this.playAnimation('anime01', true);
          });
        },

        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å†ç”Ÿé–¢æ•°
        playAnimation: function (clipName, loop = false) {
          if (this.isAnimating) return;
          
          this.el.setAttribute('animation-mixer', {
            clip: clipName,
            loop: loop ? 'repeat' : 'once',
            clampWhenFinished: !loop,
            timeScale: 1
          });

          // ãƒ«ãƒ¼ãƒ—ã—ãªã„ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®å ´åˆã€å®Œäº†ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç›£è¦–
          if (!loop) {
            const mixer = this.el.components['animation-mixer'].mixer;
            if (mixer) {
              this.isAnimating = true;
              const onFinished = () => {
                mixer.removeEventListener('finished', onFinished);
                this.isAnimating = false;
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†å¾Œã®å‡¦ç†ã‚’ã“ã“ã§è¡Œã†
                this.onAnimationComplete(clipName);
              };
              mixer.addEventListener('finished', onFinished);
            }
          }
        },

        // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³å®Œäº†æ™‚ã®å‡¦ç†
        onAnimationComplete: function (completedClip) {
          if (completedClip === 'anime02') {
            // anime02å®Œäº†å¾Œã€anime03ã‚’ãƒ«ãƒ¼ãƒ—å†ç”Ÿã—ãªãŒã‚‰ç§»å‹•
            this.playAnimation('anime03', true);
            this.moveModel();
          }
        },

        // ãƒ¢ãƒ‡ãƒ«ã‚’æ–°ã—ã„ä½ç½®ã«ç§»å‹•
        moveModel: function () {
          this.el.setAttribute('animation__position', {
            property: 'position',
            to: this.data.moveToPosition,
            dur: 3000, // 3ç§’ã‹ã‘ã¦ç§»å‹•
            easing: 'easeInOutQuad'
          });

          // ç§»å‹•å®Œäº†å¾Œã®å‡¦ç†
          this.el.addEventListener('animationcomplete__position', () => {
            if (this.currentState === 'initial') {
              this.currentState = 'moved';
              // ç§»å‹•å®Œäº†å¾Œã€anime01ã®ãƒ«ãƒ¼ãƒ—å†ç”Ÿã«æˆ»ã‚‹
              this.playAnimation('anime01', true);
            }
          }, { once: true });
        }
      });

      // ã‚¯ãƒªãƒƒã‚¯æ¤œçŸ¥ç”¨ã®å½“ãŸã‚Šåˆ¤å®šã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ
      AFRAME.registerComponent('clickable', {
        init: function () {
          console.log('Clickable component initialized');
          
          // çŠ¶æ…‹ç®¡ç†
          this.isIntersected = false;
          this.isHovered = false;
          this.hoverTimeout = null;
          this.isSoundPlaying = false; // ã‚µã‚¦ãƒ³ãƒ‰å†ç”ŸçŠ¶æ…‹ã‚’ç®¡ç†
          this.clickCount = 0; // ã‚¯ãƒªãƒƒã‚¯å›æ•°ã‚’ç®¡ç†
          this.lastClickTime = 0; // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯æ¤œçŸ¥ç”¨
          
          // ã‚¯ãƒªãƒƒã‚¯å›æ•°è¡¨ç¤ºã‚’åˆæœŸåŒ–
          this.updateClickDisplay();
          
          // ARã§ã®ã‚¯ãƒªãƒƒã‚¯æ¤œçŸ¥ã®ãŸã‚ã€raycasterã¨cursorã‚’ä½¿ç”¨
          this.el.setAttribute('cursor-listener', '');
          
          // è¤‡æ•°ã®ã‚¤ãƒ™ãƒ³ãƒˆã‚¿ã‚¤ãƒ—ã‚’è¨­å®šï¼ˆå„ªå…ˆåº¦é †ï¼‰
          this.el.addEventListener('raycaster-intersected', this.onIntersected.bind(this));
          this.el.addEventListener('raycaster-intersected-cleared', this.onIntersectedCleared.bind(this));
          
          // A-Frame cursor ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆé«˜ç²¾åº¦ï¼‰
          this.el.addEventListener('mouseenter', this.onCursorEnter.bind(this));
          this.el.addEventListener('mouseleave', this.onCursorLeave.bind(this));
          
          // å¾“æ¥ã®ãƒã‚¦ã‚¹ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
          this.el.addEventListener('mouseover', this.onHover.bind(this));
          this.el.addEventListener('mouseout', this.onHoverEnd.bind(this));
          
          // ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
          this.el.addEventListener('mousedown', this.onClick.bind(this));
          this.el.addEventListener('touchstart', this.onClick.bind(this));
          this.el.addEventListener('click', this.onClick.bind(this));
          
          // é€£ç¶šçš„ãªãƒã‚¦ã‚¹ç§»å‹•ç›£è¦–
          this.setupContinuousMonitoring();
        },

        setupContinuousMonitoring: function () {
          // ãƒã‚¦ã‚¹ä½ç½®ã®é€£ç¶šç›£è¦–
          this.mouseMonitorInterval = setInterval(() => {
            const raycaster = this.el.sceneEl.systems.raycaster;
            if (raycaster && raycaster.raycaster) {
              const intersections = raycaster.raycaster.intersectObject(this.el.object3D, true);
              if (intersections.length > 0 && !this.isIntersected) {
                this.onIntersected();
              } else if (intersections.length === 0 && this.isIntersected) {
                this.onIntersectedCleared();
              }
            }
          }, 100); // 100msã”ã¨ã«ãƒã‚§ãƒƒã‚¯
        },

        onIntersected: function (evt) {
          if (this.isIntersected) return; // é‡è¤‡é˜²æ­¢
          
          console.log('Raycaster intersected - HIGH PRECISION');
          this.isIntersected = true;
          
          // é…å»¶ã‚’ã‚¯ãƒªã‚¢ã—ã¦å³åº§ã«åå¿œ
          if (this.hoverTimeout) {
            clearTimeout(this.hoverTimeout);
            this.hoverTimeout = null;
          }
          
          // è¦–è¦šçš„ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆé»„è‰²ã§å¼·èª¿ï¼‰
          this.el.setAttribute('material', 'opacity: 0.7; color: #ffff00; emissive: #444400');
        },

        onIntersectedCleared: function (evt) {
          if (!this.isIntersected) return; // é‡è¤‡é˜²æ­¢
          
          console.log('Raycaster intersection cleared');
          
          // å°‘ã—é…å»¶ã•ã›ã¦ã¡ã‚‰ã¤ãã‚’é˜²æ­¢
          this.hoverTimeout = setTimeout(() => {
            this.isIntersected = false;
            this.isHovered = false;
            // å…ƒã®çŠ¶æ…‹ã«æˆ»ã™
            this.el.setAttribute('material', 'opacity: 0.2; color: #ffffff; emissive: #000000');
          }, 50);
        },

        onCursorEnter: function (evt) {
          console.log('Cursor entered - CURSOR EVENT');
          this.isHovered = true;
          
          if (this.hoverTimeout) {
            clearTimeout(this.hoverTimeout);
            this.hoverTimeout = null;
          }
          
          this.el.setAttribute('material', 'opacity: 0.8; color: #00ff00; emissive: #004400');
        },

        onCursorLeave: function (evt) {
          console.log('Cursor left - CURSOR EVENT');
          
          this.hoverTimeout = setTimeout(() => {
            this.isHovered = false;
            if (!this.isIntersected) {
              this.el.setAttribute('material', 'opacity: 0.2; color: #ffffff; emissive: #000000');
            }
          }, 50);
        },

        onHover: function (evt) {
          console.log('Mouse hover detected - MOUSE EVENT');
          this.isHovered = true;
          
          if (this.hoverTimeout) {
            clearTimeout(this.hoverTimeout);
            this.hoverTimeout = null;
          }
          
          this.el.setAttribute('material', 'opacity: 0.6; color: #00ff00; emissive: #002200');
        },

        onHoverEnd: function (evt) {
          console.log('Mouse hover ended - MOUSE EVENT');
          
          this.hoverTimeout = setTimeout(() => {
            this.isHovered = false;
            if (!this.isIntersected) {
              this.el.setAttribute('material', 'opacity: 0.2; color: #ffffff; emissive: #000000');
            }
          }, 50);
        },

        onClick: function (evt) {
          console.log('Click detected on clickable object', evt.type);
          evt.preventDefault();
          evt.stopPropagation();
          
          // ã‚µã‚¦ãƒ³ãƒ‰å†ç”Ÿä¸­ã¯ã‚¯ãƒªãƒƒã‚¯ã‚’ç„¡åŠ¹ã«ã™ã‚‹
          if (this.isSoundPlaying) {
            console.log('Sound is playing - click ignored');
            return;
          }
          
          // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯æ¤œçŸ¥ï¼ˆ500msä»¥å†…ã®é€£ç¶šã‚¯ãƒªãƒƒã‚¯ï¼‰
          const currentTime = Date.now();
          if (currentTime - this.lastClickTime < 500) {
            // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ - ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
            this.clickCount = 0;
            this.updateClickDisplay();
            console.log('Double click detected - counter reset');
            this.showCelebrationMessage('ğŸ”„ ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãƒªã‚»ãƒƒãƒˆï¼');
            this.lastClickTime = 0;
            return;
          }
          this.lastClickTime = currentTime;
          
          // ã‚¯ãƒªãƒƒã‚¯å›æ•°ã‚’å¢—åŠ 
          this.clickCount++;
          this.updateClickDisplay();
          console.log('Click count:', this.clickCount);
          
          // ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ãŸã³ã«ã‚µã‚¦ãƒ³ãƒ‰ã‚’å†ç”Ÿ
          this.playClickSound();
          
          // è¦ªè¦ç´ ï¼ˆãƒ¢ãƒ‡ãƒ«æœ¬ä½“ï¼‰ã®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ã‚’å–å¾—
          const modelController = this.el.parentNode.components['model-controller'];
          if (modelController && modelController.currentState === 'initial') {
            console.log('Triggering anime02 animation');
            // anime02ã‚’1å›å†ç”Ÿ
            modelController.playAnimation('anime02', false);
          } else {
            console.log('Model controller not available or not in initial state - but sound still plays');
          }
        },

        // ã‚¯ãƒªãƒƒã‚¯å›æ•°è¡¨ç¤ºã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        updateClickDisplay: function () {
          const clickCountElement = document.getElementById('click-count');
          if (clickCountElement) {
            clickCountElement.textContent = this.clickCount;
            
            // ã‚¯ãƒªãƒƒã‚¯æ™‚ã«ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœã‚’è¿½åŠ 
            if (this.clickCount > 0) {
              clickCountElement.style.transform = 'scale(1.2)';
              clickCountElement.style.color = '#ffff00';
              setTimeout(() => {
                clickCountElement.style.transform = 'scale(1)';
                clickCountElement.style.color = 'white';
              }, 200);
            }
            
            // ç‰¹å®šã®å›æ•°ã§ãŠç¥ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
            if (this.clickCount === 10) {
              this.showCelebrationMessage('ğŸ‰ 10å›é”æˆï¼');
            } else if (this.clickCount === 50) {
              this.showCelebrationMessage('ğŸŒŸ 50å›é”æˆï¼ã™ã”ã„ï¼');
            } else if (this.clickCount === 100) {
              this.showCelebrationMessage('ğŸ† 100å›é”æˆï¼ç´ æ™´ã‚‰ã—ã„ï¼');
            }
          } else {
            console.warn('Click count display element not found');
          }
        },

        // ãŠç¥ã„ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤ºã™ã‚‹é–¢æ•°
        showCelebrationMessage: function (message) {
          const counterDiv = document.getElementById('click-counter');
          if (counterDiv) {
            // ä¸€æ™‚çš„ã«ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
            const originalText = counterDiv.innerHTML;
            counterDiv.innerHTML = `<div style="color: #ffff00; font-size: 20px;">${message}</div>`;
            counterDiv.style.background = 'rgba(255,215,0,0.9)';
            counterDiv.style.color = 'black';
            
            setTimeout(() => {
              counterDiv.innerHTML = originalText;
              counterDiv.style.background = 'rgba(0,0,0,0.7)';
              counterDiv.style.color = 'white';
            }, 2000);
          }
        },

        // ã‚¯ãƒªãƒƒã‚¯æ™‚ã®ã‚µã‚¦ãƒ³ãƒ‰å†ç”Ÿé–¢æ•°
        playClickSound: function () {
          try {
            const soundElement = document.getElementById('sound01');
            if (soundElement) {
              // ã‚µã‚¦ãƒ³ãƒ‰å†ç”ŸçŠ¶æ…‹ã‚’trueã«è¨­å®š
              this.isSoundPlaying = true;
              
              // æ—¢ã«å†ç”Ÿä¸­ã®å ´åˆã¯åœæ­¢ã—ã¦ã‹ã‚‰å†ç”Ÿ
              soundElement.currentTime = 0;
              const playPromise = soundElement.play();
              
              // ã‚µã‚¦ãƒ³ãƒ‰çµ‚äº†ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç›£è¦–
              soundElement.addEventListener('ended', () => {
                this.isSoundPlaying = false;
                console.log('Sound playback finished - clicks enabled');
              }, { once: true });
              
              // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚ã‚µã‚¦ãƒ³ãƒ‰çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
              soundElement.addEventListener('error', () => {
                this.isSoundPlaying = false;
                console.log('Sound playback error - clicks enabled');
              }, { once: true });
              
              if (playPromise !== undefined) {
                playPromise.then(() => {
                  console.log('Click sound started successfully - clicks disabled during playback');
                }).catch(error => {
                  console.warn('Click sound playback failed:', error);
                  this.isSoundPlaying = false; // ã‚¨ãƒ©ãƒ¼æ™‚ã¯çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
                });
              }
            } else {
              console.warn('Sound01 element not found');
              this.isSoundPlaying = false;
            }
          } catch (error) {
            console.error('Error playing click sound:', error);
            this.isSoundPlaying = false; // ã‚¨ãƒ©ãƒ¼æ™‚ã¯çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
          }
        },

        remove: function () {
          // ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
          if (this.mouseMonitorInterval) {
            clearInterval(this.mouseMonitorInterval);
          }
          if (this.hoverTimeout) {
            clearTimeout(this.hoverTimeout);
          }
          
          // ã‚µã‚¦ãƒ³ãƒ‰çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
          this.isSoundPlaying = false;
          
          // ã‚µã‚¦ãƒ³ãƒ‰è¦ç´ ã®åœæ­¢
          const soundElement = document.getElementById('sound01');
          if (soundElement) {
            soundElement.pause();
            soundElement.currentTime = 0;
          }
        }
      });
    </script>
    <title>**26***</title>
  </head>
  <body style="margin: 0; overflow: hidden">
    
    <!-- ã‚¯ãƒªãƒƒã‚¯å›æ•°è¡¨ç¤º -->
    <div id="click-counter" style="position: fixed; top: 20px; left: 20px; background: rgba(0,0,0,0.7); color: white; padding: 10px 15px; border-radius: 10px; font-family: Arial, sans-serif; font-size: 18px; font-weight: bold; z-index: 1000;">
      ã‚¯ãƒªãƒƒã‚¯å›æ•°: <span id="click-count">0</span>
    </div>
	  
    <!-- A-Frameã«AR.jsã‚’ç´ã¥ã‘ã€VRãƒœã‚¿ãƒ³éè¡¨ç¤ºã€æ·±åº¦ãƒãƒƒãƒ•ã‚¡è¿½åŠ  -->
    <a-scene embedded arjs vr-mode-ui="enabled: false;" 
      renderer="logarithmicDepthBuffer: true; colorManagement: true; physicallyCorrectLights: true; exposure: 1.2;"
      cursor="rayOrigin: mouse; fuseTimeout: 0" 
      raycaster="objects: .clickable; far: 1000; near: 0.1; interval: 50">
	    
      <!-- 3DCGãƒ¢ãƒ‡ãƒ«ã‚’èª­ã¿è¾¼ã‚€ -->
      <a-assets>
        <a-asset-item id="neko" src="./assets/3Dmodel.glb"></a-asset-item>
        <audio id="sound01" src="./assets/sound01.mp3" preload="auto"></audio>
      </a-assets>

      <!-- ãƒ©ã‚¤ãƒ†ã‚£ãƒ³ã‚°è¨­å®š -->
      <a-entity light="type: ambient; intensity: 1.5; color: #ffffff"></a-entity>
      <a-entity light="type: directional; intensity: 1.2; color: #ffffff" position="-1 1 0.5"></a-entity>
      <a-entity light="type: hemisphere; intensity: 0.8; color: #ffffff; groundColor: #888888"></a-entity>

      <!-- ãƒãƒ¼ã‚«ãƒ¼ã®.pattãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€ -->
      <a-marker type="pattern" url="./assets/pattern-marker.patt">
        <!-- ãƒ¢ãƒ‡ãƒ«ã®ã‚³ãƒ³ãƒ†ãƒŠï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã¨ç§»å‹•ã®åˆ¶å¾¡ç”¨ï¼‰ -->
        <a-entity
          id="model-container"
          model-controller
          gesture-handler="minScale: 0.25; maxScale: 10"
          animation-mixer>
          
          <!-- 3Dãƒ¢ãƒ‡ãƒ«æœ¬ä½“ -->
          <a-entity
            gltf-model="#neko"
            scale="1.5 1.5 1.5"
            rotation="0 0 0">
          </a-entity>

          <!-- ã‚¯ãƒªãƒƒã‚¯åˆ¤å®šç”¨ã®é€æ˜ãªãƒœãƒƒã‚¯ã‚¹ï¼ˆå½“ãŸã‚Šåˆ¤å®šï¼‰ -->
          <a-box
            clickable
            scale="2 2 2"
            position="0 0 0"
            material="opacity: 0.2; transparent: true; color: #ffffff; side: double"
            geometry="primitive: box"
            class="clickable"
            raycaster-listen>
          </a-box>
        </a-entity>
      </a-marker>

      <!-- ã‚«ãƒ¡ãƒ©ã‚’è¿½åŠ ï¼ˆraycasterã¨cursorä»˜ãï¼‰ -->
      <a-entity camera
        raycaster="objects: .clickable; far: 1000; near: 0.1; showLine: false; interval: 50; lineColor: red; lineOpacity: 0.5"
        cursor="rayOrigin: mouse; fuseTimeout: 0; downEvents: mousedown,touchstart; upEvents: mouseup,touchend">
      </a-entity>
    </a-scene>
  </body>
</html>